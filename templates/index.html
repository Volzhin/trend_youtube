<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Shorts Parser</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .content {
            padding: 30px;
        }
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .file-card {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .file-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .file-title {
            font-weight: 600;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #2c3e50;
            line-height: 1.4;
        }
        .file-meta {
            color: #6c757d;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        .file-actions {
            display: flex;
            gap: 10px;
        }
        .download-btn {
            background: linear-gradient(135deg, #00b894, #00a085);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }
        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            text-decoration: none;
            color: white;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 10px;
            font-weight: 500;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéµ YouTube Shorts Parser</h1>
            <p>–ü–æ–∏—Å–∫ –∏ –æ–Ω–ª–∞–π–Ω –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–¥–æ–≤—ã—Ö –∞—É–¥–∏–æ –∏–∑ YouTube Shorts (–°–®–ê)</p>
        </div>
        
        <div class="controls">
            <button class="btn" onclick="runPipeline()" id="pipelineBtn">
                üîÑ –û–±–Ω–æ–≤–∏—Ç—å –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
            </button>
            <button class="btn" onclick="showTrending()" id="trendingBtn">
                üìà –ü–æ–∫–∞–∑–∞—Ç—å —Ç—Ä–µ–Ω–¥—ã
            </button>
        </div>
        
        <div class="search-section" style="padding: 20px 30px; background: #f8f9fa; border-bottom: 1px solid #e9ecef;">
            <h3 style="margin: 0 0 15px 0; color: #2c3e50;">üîç –ü–æ–∏—Å–∫ —Ç—Ä–µ–Ω–¥–æ–≤—ã—Ö –∑–≤—É–∫–æ–≤</h3>
            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <input type="text" id="searchInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å..." 
                       style="flex: 1; min-width: 200px; padding: 10px; border: 1px solid #ddd; border-radius: 25px; font-size: 14px;">
                <input type="number" id="maxResults" value="50" min="10" max="100" 
                       style="width: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 25px; font-size: 14px;">
                <button class="btn" onclick="searchCustom()" id="searchBtn">
                    üîç –ü–æ–∏—Å–∫
                </button>
                <button class="btn" onclick="clearSearch()" id="clearBtn" style="background: linear-gradient(135deg, #95a5a6, #7f8c8d);">
                    üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                </button>
            </div>
            <div style="margin-top: 10px;">
                <small style="color: #6c757d;">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã: </small>
                <div id="popularQueries" style="display: inline-block; margin-left: 10px;"></div>
            </div>
        </div>

        <div class="content">
            <div id="status"></div>
            
            <div class="stats" id="stats" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalFiles">0</div>
                    <div class="stat-label">–°–∫–∞—á–∞–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalDuration">0</div>
                    <div class="stat-label">–û–±—â–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</div>
                </div>
            </div>

            <div id="content">
                <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...</div>
            </div>
        </div>
    </div>

    <script>
        let files = [];
        let trending = [];
        let searchQueries = [];

        async function runPipeline() {
            const btn = document.getElementById('pipelineBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';
            
            try {
                const response = await fetch('/run_pipeline', { method: 'POST' });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showStatus('–ü–∞–π–ø–ª–∞–π–Ω –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
                    await refreshFiles();
                } else {
                    showStatus('–û—à–∏–±–∫–∞: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–∞–π–ø–ª–∞–π–Ω–∞:', error);
                showStatus('–û—à–∏–±–∫–∞: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîÑ –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥';
            }
        }

        async function refreshFiles() {
            // –§—É–Ω–∫—Ü–∏—è –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞, —Ç–∞–∫ –∫–∞–∫ –º—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
            showTrending();
        }

        async function showTrending() {
            try {
                const response = await fetch('/api/trending');
                trending = await response.json();
                renderTrending();
            } catch (error) {
                showStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–µ–Ω–¥–æ–≤: ' + error.message, 'error');
            }
        }

        function renderFiles() {
            // –§—É–Ω–∫—Ü–∏—è –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞, —Ç–∞–∫ –∫–∞–∫ –º—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
            showTrending();
        }

        function renderTrending() {
            const content = document.getElementById('content');
            const trendingHtml = trending.map((item, index) => `
                <div class="file-card">
                    <div class="file-title">${item.title}</div>
                    <div class="file-meta">
                        <strong>–ö–∞–Ω–∞–ª:</strong> ${item.channel_title}<br>
                        <strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${Math.round(item.duration_sec / 60 * 10) / 10} –º–∏–Ω<br>
                        ${item.primary_genre ? `<strong>–ñ–∞–Ω—Ä:</strong> ${item.primary_genre} (${(item.genre_confidence * 100).toFixed(1)}%)<br>` : ''}
                        ${item.stats ? `
                            <strong>üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</strong> ${item.stats.view_count.toLocaleString('ru-RU')}<br>
                            <strong>üëç –õ–∞–π–∫–∏:</strong> ${item.stats.like_count.toLocaleString('ru-RU')}<br>
                            <strong>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</strong> ${item.stats.comment_count.toLocaleString('ru-RU')}<br>
                            <strong>üìÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ:</strong> ${new Date(item.stats.last_updated).toLocaleDateString('ru-RU')}
                        ` : ''}
                    </div>
                    <div class="file-actions">
                        <button class="btn" onclick="playAudio('${item.video_id}')" style="background: linear-gradient(135deg, #667eea, #764ba2); margin-right: 10px;">
                            üéµ –ü—Ä–æ—Å–ª—É—à–∞—Ç—å
                        </button>
                        <button class="btn" onclick="getDirectLink('${item.video_id}')" style="background: linear-gradient(135deg, #00b894, #00a085); margin-right: 10px;">
                            üîó –ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É
                        </button>
                        <a href="https://www.youtube.com/watch?v=${item.video_id}" target="_blank" class="btn" style="background: linear-gradient(135deg, #ff6b6b, #ee5a52); text-decoration: none; display: inline-block;">
                            üì∫ YouTube Shorts
                        </a>
                    </div>
                    <div id="player-${item.video_id}" style="margin-top: 10px; display: none;">
                        <audio controls style="width: 100%;">
                            <source id="audio-src-${item.video_id}" src="" type="audio/mpeg">
                            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç.
                        </audio>
                    </div>
                    <div id="link-${item.video_id}" style="margin-top: 10px; display: none;">
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 12px; word-break: break-all;">
                            <strong>–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞:</strong><br>
                            <span id="direct-url-${item.video_id}"></span>
                        </div>
                    </div>
                </div>
            `).join('');

            content.innerHTML = `
                <h2>üìà –¢—Ä–µ–Ω–¥–æ–≤—ã–µ Shorts</h2>
                <div class="file-grid">${trendingHtml}</div>
            `;
        }

        function updateStats() {
            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω–∞, —Ç–∞–∫ –∫–∞–∫ –º—ã –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã
            document.getElementById('stats').style.display = 'none';
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        async function searchCustom() {
            const query = document.getElementById('searchInput').value.trim();
            const maxResults = document.getElementById('maxResults').value;
            const btn = document.getElementById('searchBtn');
            
            if (!query) {
                showStatus('–í–≤–µ–¥–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å', 'error');
                return;
            }
            
            btn.disabled = true;
            btn.textContent = '‚è≥ –ü–æ–∏—Å–∫...';
            
            try {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π API –¥–ª—è –ø–æ–∏—Å–∫–∞ —Å –ø—Ä—è–º—ã–º–∏ —Å—Å—ã–ª–∫–∞–º–∏
                const response = await fetch(`/api/search_direct_links?query=${encodeURIComponent(query)}&max_results=${parseInt(maxResults)}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    showStatus(result.message, 'success');
                    displaySearchResultsInMainArea(result.links);
                } else {
                    showStatus('–û—à–∏–±–∫–∞: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
                showStatus('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'üîç –ü–æ–∏—Å–∫';
            }
        }

        function displaySearchResultsInMainArea(tracks) {
            const content = document.getElementById('content');
            
            if (tracks.length === 0) {
                content.innerHTML = '<div class="loading">–¢—Ä–µ–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å.</div>';
                return;
            }

            const tracksHtml = tracks.map((track, index) => `
                <div class="file-card">
                    <div class="file-title">${track.title}</div>
                    <div class="file-meta">
                        <strong>–ö–∞–Ω–∞–ª:</strong> ${track.channel_title}<br>
                        <strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${Math.round(track.duration_sec / 60 * 10) / 10} –º–∏–Ω<br>
                        ${track.primary_genre ? `<strong>–ñ–∞–Ω—Ä:</strong> ${track.primary_genre} (${(track.genre_confidence * 100).toFixed(1)}%)<br>` : ''}
                        ${track.stats ? `
                            <strong>üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä—ã:</strong> ${track.stats.view_count.toLocaleString('ru-RU')}<br>
                            <strong>üëç –õ–∞–π–∫–∏:</strong> ${track.stats.like_count.toLocaleString('ru-RU')}<br>
                            <strong>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏:</strong> ${track.stats.comment_count.toLocaleString('ru-RU')}<br>
                            <strong>üìÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ:</strong> ${new Date(track.stats.last_updated).toLocaleDateString('ru-RU')}
                        ` : ''}
                    </div>
                    <div class="file-actions">
                        <button class="btn" onclick="playAudio('${track.video_id}')" style="background: linear-gradient(135deg, #667eea, #764ba2); margin-right: 10px;">
                            üéµ –ü—Ä–æ—Å–ª—É—à–∞—Ç—å
                        </button>
                        <button class="btn" onclick="getDirectLink('${track.video_id}')" style="background: linear-gradient(135deg, #00b894, #00a085); margin-right: 10px;">
                            üîó –ü–æ–ª—É—á–∏—Ç—å —Å—Å—ã–ª–∫—É
                        </button>
                        <a href="${track.youtube_url}" target="_blank" class="btn" style="background: linear-gradient(135deg, #ff6b6b, #ee5a52); text-decoration: none; display: inline-block;">
                            üì∫ YouTube Shorts
                        </a>
                    </div>
                    <div id="player-${track.video_id}" style="margin-top: 10px; display: none;">
                        <audio controls style="width: 100%;">
                            <source id="audio-src-${track.video_id}" src="" type="audio/mpeg">
                            –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ —ç–ª–µ–º–µ–Ω—Ç.
                        </audio>
                    </div>
                    <div id="link-${track.video_id}" style="margin-top: 10px; display: none;">
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 12px; word-break: break-all;">
                            <strong>–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞:</strong><br>
                            <span id="direct-url-${track.video_id}"></span>
                        </div>
                    </div>
                </div>
            `).join('');

            content.innerHTML = `
                <h2>üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞</h2>
                <div class="file-grid">${tracksHtml}</div>
            `;
        }

        function clearSearch() {
            document.getElementById('searchInput').value = '';
            showTrending();
            showStatus('–ü–æ–∏—Å–∫ –æ—á–∏—â–µ–Ω', 'success');
        }

        async function playAudio(videoId) {
            const playerDiv = document.getElementById(`player-${videoId}`);
            const audioSrc = document.getElementById(`audio-src-${videoId}`);
            
            if (playerDiv.style.display === 'none') {
                try {
                    // –ü–æ–ª—É—á–∞–µ–º –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ –∞—É–¥–∏–æ
                    const response = await fetch(`/api/direct_download/${videoId}`);
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        audioSrc.src = result.direct_download_url;
                        playerDiv.style.display = 'block';
                        
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
                        const audio = playerDiv.querySelector('audio');
                        audio.load();
                        audio.play().catch(e => console.log('–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ'));
                    } else {
                        showStatus('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞—É–¥–∏–æ: ' + result.message, 'error');
                    }
                } catch (error) {
                    showStatus('–û—à–∏–±–∫–∞: ' + error.message, 'error');
                }
            } else {
                playerDiv.style.display = 'none';
            }
        }

        async function getDirectLink(videoId) {
            const linkDiv = document.getElementById(`link-${videoId}`);
            const urlSpan = document.getElementById(`direct-url-${videoId}`);
            
            if (linkDiv.style.display === 'none') {
                try {
                    const response = await fetch(`/api/direct_download/${videoId}`);
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        urlSpan.textContent = result.direct_download_url;
                        linkDiv.style.display = 'block';
                        
                        // –ö–æ–ø–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞
                        navigator.clipboard.writeText(result.direct_download_url).then(() => {
                            showStatus('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
                        }).catch(() => {
                            showStatus('–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞!', 'success');
                        });
                    } else {
                        showStatus('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏: ' + result.message, 'error');
                    }
                } catch (error) {
                    showStatus('–û—à–∏–±–∫–∞: ' + error.message, 'error');
                }
            } else {
                linkDiv.style.display = 'none';
            }
        }

        async function loadSearchQueries() {
            try {
                const response = await fetch('/api/search_queries');
                searchQueries = await response.json();
                renderPopularQueries();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:', error);
            }
        }

        function renderPopularQueries() {
            const container = document.getElementById('popularQueries');
            const queryButtons = searchQueries.map(query => 
                `<button class="btn" style="margin: 2px; padding: 5px 10px; font-size: 12px;" 
                         onclick="document.getElementById('searchInput').value='${query}'; searchCustom();">
                    ${query}
                </button>`
            ).join('');
            container.innerHTML = queryButtons;
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç—Ä–µ–Ω–¥—ã –∏ –ø–æ–∏—Å–∫–æ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            showTrending();
            loadSearchQueries();
        });
    </script>
</body>
</html>
